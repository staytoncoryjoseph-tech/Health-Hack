<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Health Hack | Medical AI</title>
  <meta name="description" content="Health Hack Medical AI: prevention-focused guidance, tracking, and educational tools. Not medical advice." />

  <style>
    :root {
      --bg-main: #f5faff;
      --bg-panel: #eaf4ff;
      --bg-card: #ffffff;

      --blue-1: #38bdf8;
      --blue-2: #0ea5e9;
      --blue-3: #0284c7;

      --silver-1: #e5e7eb;
      --silver-2: #cbd5e1;
      --silver-3: #94a3b8;

      --text-main: #0f172a;
      --text-soft: #334155;
      --text-invert: #ffffff;

      --success: #22c55e;
      --warning: #facc15;
      --danger: #ef4444;

      --shadow-soft: 0 10px 28px rgba(56, 189, 248, 0.25);
      --glow-blue: 0 0 18px rgba(56, 189, 248, 0.45);
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
      color: var(--text-main);
      background: linear-gradient(180deg, #f0f9ff 0%, #e0f2fe 55%, #f8fafc 100%);
      min-height: 100vh;
    }

    a { color: var(--blue-3); text-decoration: none; }
    a:hover { text-decoration: underline; }

    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 22px;
    }

    /* Header */
    .topbar {
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: blur(10px);
      background: rgba(245, 250, 255, 0.72);
      border-bottom: 1px solid rgba(203, 213, 225, 0.7);
    }

    .topbar-inner {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 14px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 800;
      letter-spacing: 0.2px;
    }

    .brand-badge {
      width: 40px;
      height: 40px;
      border-radius: 14px;
      background: radial-gradient(circle at 25% 20%, rgba(56,189,248,.9), rgba(14,165,233,.65) 45%, rgba(2,132,199,.4) 85%);
      box-shadow: var(--glow-blue);
      border: 1px solid rgba(148,163,184,.35);
    }

    .nav-actions {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .pill {
      border-radius: 999px;
      padding: 10px 14px;
      border: 1px solid var(--silver-2);
      background: rgba(255,255,255,.8);
      color: var(--text-main);
      cursor: pointer;
      font-weight: 600;
      transition: transform .15s ease, box-shadow .15s ease, border-color .15s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      user-select: none;
    }

    .pill:hover { transform: translateY(-1px); border-color: rgba(14,165,233,.55); box-shadow: 0 10px 22px rgba(2,132,199,.12); }
    .pill:active { transform: translateY(0px); }

    .pill-primary {
      border: none;
      background: linear-gradient(135deg, var(--blue-1), var(--blue-2));
      color: var(--text-invert);
      box-shadow: var(--glow-blue);
    }

    .pill-ghost {
      background: transparent;
      border: 1px solid rgba(2,132,199,.25);
      color: var(--blue-3);
    }

    /* Hero */
    .hero {
      padding: 18px 0 10px;
    }

    .hero-grid {
      display: grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap: 18px;
      align-items: stretch;
    }

    @media (max-width: 880px) {
      .hero-grid { grid-template-columns: 1fr; }
      .nav-actions { justify-content: flex-start; }
    }

    .card {
      background: var(--bg-card);
      border-radius: 22px;
      padding: 22px;
      border: 1px solid var(--silver-1);
      box-shadow: var(--shadow-soft);
    }

    .hero h1 {
      margin: 0 0 10px;
      font-size: clamp(1.6rem, 3vw, 2.2rem);
      letter-spacing: -0.5px;
    }

    .subtext {
      margin: 0;
      color: var(--text-soft);
      line-height: 1.6;
    }

    .notice {
      margin-top: 14px;
      border-radius: 16px;
      padding: 14px;
      border: 1px solid rgba(239,68,68,.25);
      background: linear-gradient(180deg, rgba(239,68,68,.08), rgba(239,68,68,.03));
      color: #7f1d1d;
      font-weight: 650;
      line-height: 1.5;
    }

    .notice small {
      display: block;
      margin-top: 6px;
      font-weight: 600;
      color: rgba(127,29,29,.85);
    }

    /* Quick tracking */
    .stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }

    @media (max-width: 640px) {
      .stats { grid-template-columns: 1fr; }
    }

    .stat {
      border-radius: 18px;
      padding: 16px;
      border: 1px solid var(--silver-1);
      background: linear-gradient(180deg, #ffffff, #f8fafc);
    }

    .stat-label {
      color: var(--text-soft);
      font-weight: 700;
      font-size: 0.92rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .stat-value {
      margin-top: 10px;
      font-size: 1.3rem;
      font-weight: 850;
      letter-spacing: -0.3px;
      color: var(--blue-3);
    }

    .stat small {
      display: block;
      margin-top: 6px;
      color: var(--silver-3);
      font-weight: 650;
    }

    /* Controls */
    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    .input {
      width: 100%;
      background: #f8fafc;
      border: 1px solid var(--silver-2);
      border-radius: 14px;
      padding: 12px 14px;
      font-size: 15px;
      color: var(--text-main);
      outline: none;
    }
    .input:focus {
      border-color: var(--blue-1);
      box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.25);
    }

    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 640px) { .grid-2 { grid-template-columns: 1fr; } }

    /* Chat */
    .chat-wrap {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-top: 18px;
    }

    .chat-log {
      height: 320px;
      overflow: auto;
      border-radius: 18px;
      border: 1px solid var(--silver-1);
      background: linear-gradient(180deg, #ffffff, #f8fafc);
      padding: 12px;
    }

    .msg {
      padding: 12px 12px;
      border-radius: 14px;
      margin: 10px 0;
      line-height: 1.5;
      border: 1px solid rgba(203,213,225,.7);
    }

    .msg.user {
      background: rgba(56,189,248,.12);
      border-color: rgba(56,189,248,.25);
    }

    .msg.ai {
      background: rgba(148,163,184,.10);
      border-color: rgba(148,163,184,.22);
    }

    .msg .who {
      font-weight: 850;
      color: var(--blue-3);
      display: inline-block;
      margin-bottom: 6px;
      letter-spacing: -0.2px;
    }

    .chat-row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: center;
    }

    /* CPR SECTION */
    .cpr-section {
      margin-top: 70px;
      padding: 52px 20px;
      background: linear-gradient(180deg, #e0f2fe, #f8fafc);
      border-top: 1px solid rgba(203,213,225,.7);
    }

    .cpr-card {
      max-width: 900px;
      margin: auto;
      background: #ffffff;
      border-radius: 22px;
      padding: 32px;
      border: 1px solid #cbd5e1;
      box-shadow: var(--shadow-soft);
    }

    .cpr-card h2 {
      margin: 0 0 16px;
      color: var(--blue-2);
      font-size: 1.6rem;
      letter-spacing: -0.2px;
    }

    .cpr-steps {
      padding-left: 20px;
      margin: 14px 0 0;
    }

    .cpr-steps li {
      margin-bottom: 16px;
      line-height: 1.6;
      color: var(--text-main);
    }

    .cpr-steps strong { color: var(--blue-3); }

    .highlight { color: var(--blue-2); font-weight: 800; }

    .cpr-note {
      margin-top: 20px;
      padding-top: 14px;
      border-top: 1px solid var(--silver-1);
      font-size: 0.95rem;
      color: var(--text-soft);
      font-weight: 650;
    }

    /* CPR VOICE READER */
    .cpr-voice{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 14px 0 18px;
      padding: 14px 14px;
      border: 1px solid var(--silver-1);
      border-radius: 16px;
      background: #f8fafc;
    }

    .cpr-rate{
      display:flex;
      align-items:center;
      gap:10px;
      margin-left:auto;
      font-size: 0.95rem;
      color: var(--text-main);
      font-weight: 700;
    }

    .cpr-rate input[type="range"]{ width: 150px; }

    .cpr-voice-note{
      width:100%;
      margin: 6px 0 0;
      color: var(--text-soft);
      font-size: 0.95rem;
      font-weight: 650;
    }

    /* Footer */
    footer {
      padding: 22px 0 40px;
      color: var(--silver-3);
      text-align: center;
      font-weight: 650;
    }

    /* Small helpers */
    .muted { color: var(--silver-3); font-weight: 650; }
    .divider { height: 1px; background: rgba(203,213,225,.75); margin: 16px 0; }
    .tag {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(2,132,199,.18);
      background: rgba(56,189,248,.10);
      color: var(--blue-3);
      font-weight: 800;
      font-size: 0.9rem;
    }
  </style>
</head>

<body>

  <!-- Topbar -->
  <header class="topbar">
    <div class="container topbar-inner">
      <div class="brand">
        <div class="brand-badge" aria-hidden="true"></div>
        <div>
          <div>Health Hack</div>
          <div class="muted" style="font-size:.9rem; font-weight:700;">Medical AI ‚Ä¢ Prevention-first</div>
        </div>
      </div>

      <div class="nav-actions">
        <a class="pill pill-ghost" href="../index.html">üè† Home</a>
        <button class="pill" type="button" id="btnScrollChat">üí¨ Ask Medical AI</button>
        <button class="pill pill-primary" type="button" id="btnScrollCPR">üö® CPR Instructions</button>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Hero -->
    <section class="hero">
      <div class="hero-grid">
        <div class="card">
          <div class="tag">ü©∫ Medical AI (Educational)</div>
          <h1>Medical AI ‚Äî Ask questions, track basics, stay proactive.</h1>
          <p class="subtext">
            This page is designed for <strong>healthy living + prevention</strong> support (especially for people managing
            chronic conditions like <strong>lupus</strong>). You can log basics like blood pressure & steps, and use the
            assistant for <strong>education</strong>, checklists, and safer next steps.
          </p>

          <div class="notice">
            <strong>Important:</strong> This tool is not a medical professional and does not provide diagnosis or emergency care.
            If you think someone is having an emergency, <strong>call 911 now</strong>.
            <small>Use this as guidance and education ‚Äî always follow your clinician‚Äôs advice.</small>
          </div>

          <div class="divider"></div>

          <div class="grid-2">
            <div>
              <label for="bpSystolic" class="muted">Systolic (top number)</label>
              <input class="input" id="bpSystolic" inputmode="numeric" placeholder="e.g., 120" />
            </div>
            <div>
              <label for="bpDiastolic" class="muted">Diastolic (bottom number)</label>
              <input class="input" id="bpDiastolic" inputmode="numeric" placeholder="e.g., 80" />
            </div>
          </div>

          <div class="controls">
            <button class="pill pill-primary" type="button" id="btnSaveVitals">‚úÖ Save Vitals</button>
            <button class="pill" type="button" id="btnAddSteps">üëü + Steps</button>
            <button class="pill" type="button" id="btnResetToday">üîÑ Reset Today</button>
          </div>

          <p class="muted" style="margin:10px 0 0;">
            Tip: ask about lupus-friendly routines, hydration reminders, gentle exercise ideas, and symptom tracking prompts.
          </p>
        </div>

        <div class="card">
          <h2 style="margin:0 0 14px; color: var(--blue-3); letter-spacing:-0.2px;">Today Snapshot</h2>
          <div class="stats">
            <div class="stat">
              <div class="stat-label">ü´Ä Blood Pressure</div>
              <div class="stat-value" id="bpDisplay">‚Äî / ‚Äî</div>
              <small id="bpSavedAt">Not saved yet</small>
            </div>
            <div class="stat">
              <div class="stat-label">üëü Steps</div>
              <div class="stat-value" id="stepsDisplay">0</div>
              <small class="muted">Manual entry (for now)</small>
            </div>
            <div class="stat">
              <div class="stat-label">üßä Check-in</div>
              <div class="stat-value" id="checkinDisplay">Ready</div>
              <small class="muted">Prevention > reaction</small>
            </div>
          </div>

          <div class="divider"></div>

          <p class="subtext" style="margin:0;">
            <strong>Safe boundaries:</strong> This AI can explain symptoms & options, but will avoid diagnosing and will
            direct you to urgent care when needed.
          </p>
        </div>
      </div>
    </section>

    <!-- Chat -->
    <section class="card chat-wrap" id="chatSection" aria-label="Medical AI Chat">
      <h2 style="margin:0; color: var(--blue-3); letter-spacing:-0.2px;">üí¨ Ask the Medical AI</h2>
      <p class="muted" style="margin:6px 0 0;">
        Ask educational questions like: ‚ÄúWhat questions should I ask my doctor about lupus fatigue?‚Äù or ‚ÄúHow do I track blood pressure trends?‚Äù
      </p>

      <div class="chat-log" id="chatLog" aria-live="polite"></div>

      <div class="chat-row">
        <input class="input" id="chatInput" placeholder="Type your question (non-emergency)‚Ä¶" />
        <button class="pill pill-primary" type="button" id="btnSend">Send</button>
      </div>

      <p class="muted" style="margin:8px 0 0;">
        If you mention emergency symptoms (chest pain, severe shortness of breath, fainting, stroke signs), you‚Äôll be told to call 911.
      </p>
    </section>
  </main>

  <!-- ===================== CPR QUICK ACTION FOOTER ===================== -->
  <section class="cpr-section" id="cprSection" aria-label="CPR Emergency Instructions">
    <div class="cpr-card">
      <h2>üö® CPR: What To Do In An Emergency</h2>

      <!-- Voice Reader Controls -->
      <div class="cpr-voice" role="group" aria-label="CPR Voice Reader Controls">
        <button type="button" class="pill pill-primary" id="cprSpeakBtn">üîä Read CPR Aloud</button>
        <button type="button" class="pill" id="cprPauseBtn" disabled>‚è∏ Pause</button>
        <button type="button" class="pill" id="cprResumeBtn" disabled>‚ñ∂ Resume</button>
        <button type="button" class="pill" id="cprStopBtn" disabled>‚èπ Stop</button>

        <label class="cpr-rate">
          Speed
          <input id="cprRate" type="range" min="0.8" max="1.25" step="0.05" value="1" />
          <span id="cprRateLabel">1.00x</span>
        </label>

        <p class="cpr-voice-note" id="cprVoiceStatus" aria-live="polite">Voice reader ready.</p>
      </div>

      <ol class="cpr-steps">
        <li>
          <strong>Check & Call</strong><br />
          Make sure the area is safe. Tap the person and shout.<br />
          <span class="highlight">Call 911 immediately</span> or tell someone nearby to call.
        </li>

        <li>
          <strong>Push Hard & Fast</strong><br />
          Place hands in the <strong>center of the chest</strong>.<br />
          Push <strong>2 inches deep</strong> at a rate of
          <span class="highlight">100‚Äì120 compressions per minute</span>.
          <em>(Think: ‚ÄúStayin‚Äô Alive‚Äù)</em>
        </li>

        <li>
          <strong>Keep Going</strong><br />
          Let the chest rise fully between pushes.<br />
          Do not stop unless help arrives, an AED is ready, or the person wakes up.
        </li>

        <li>
          <strong>Use an AED (If Available)</strong><br />
          Turn it on and follow voice instructions.<br />
          Resume CPR immediately after any shock or ‚Äúno shock‚Äù message.
        </li>
      </ol>

      <p class="cpr-note">
        Hands-Only CPR is effective for adults.
        <strong>Doing something is always better than doing nothing.</strong>
      </p>
    </div>
  </section>

  <footer class="container">
    <div>¬© <span id="year"></span> Health Hack ‚Ä¢ Medical AI</div>
    <div class="muted" style="margin-top:6px;">
      Educational content only ‚Ä¢ Not medical advice ‚Ä¢ In emergencies call 911
    </div>
  </footer>

  <script>
    // ===========================
    // Small UI helpers
    // ===========================
    const $ = (id) => document.getElementById(id);

    const chatLog = $("chatLog");
    const chatInput = $("chatInput");

    function addMsg(who, text, cls) {
      const div = document.createElement("div");
      div.className = "msg " + cls;
      div.innerHTML = '<div class="who">' + who + '</div><div>' + escapeHtml(text).replace(/\n/g,"<br>") + '</div>';
      chatLog.appendChild(div);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // ===========================
    // Basic local tracking (BP + steps)
    // ===========================
    const STORAGE_KEY = "healthHack.medicalAI.today.v1";

    function loadToday() {
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}"); }
      catch { return {}; }
    }

    function saveToday(data) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function fmtTime(ts) {
      if (!ts) return "Not saved yet";
      const d = new Date(ts);
      return "Saved " + d.toLocaleString();
    }

    function renderToday() {
      const data = loadToday();

      const bp = (data.bpSystolic && data.bpDiastolic) ? `${data.bpSystolic} / ${data.bpDiastolic}` : "‚Äî / ‚Äî";
      $("bpDisplay").textContent = bp;
      $("bpSavedAt").textContent = fmtTime(data.bpSavedAt);

      $("stepsDisplay").textContent = (data.steps || 0).toLocaleString();

      const check = data.checkin || "Ready";
      $("checkinDisplay").textContent = check;
    }

    $("btnSaveVitals").addEventListener("click", () => {
      const sys = ($("bpSystolic").value || "").trim();
      const dia = ($("bpDiastolic").value || "").trim();

      const data = loadToday();
      data.bpSystolic = sys;
      data.bpDiastolic = dia;
      data.bpSavedAt = Date.now();
      data.checkin = "Vitals saved";

      saveToday(data);
      renderToday();

      addMsg("You", `Saved BP: ${sys || "‚Äî"} / ${dia || "‚Äî"}`, "user");
      addMsg("Medical AI", "Got it. If you want, tell me your usual range and any symptoms (dizziness, headache, chest pain). If severe symptoms, call 911.", "ai");
    });

    $("btnAddSteps").addEventListener("click", () => {
      const add = prompt("Add how many steps?", "500");
      if (add === null) return;
      const n = Math.max(0, parseInt(add, 10) || 0);

      const data = loadToday();
      data.steps = (data.steps || 0) + n;
      data.checkin = "Steps updated";
      saveToday(data);
      renderToday();

      addMsg("You", `Added steps: +${n}`, "user");
      addMsg("Medical AI", "Nice. For lupus-friendly movement: short walks, gentle stretching, and pacing are usually safer than pushing to exhaustion.", "ai");
    });

    $("btnResetToday").addEventListener("click", () => {
      if (!confirm("Reset today's vitals and steps?")) return;
      localStorage.removeItem(STORAGE_KEY);
      renderToday();
      addMsg("Medical AI", "Reset done. Start fresh when you‚Äôre ready.", "ai");
    });

    // ===========================
    // Minimal ‚ÄúMedical AI‚Äù chat (offline placeholder)
    // (Swap later with your real AI engine)
    // ===========================
    const emergencyKeywords = [
      "chest pain","shortness of breath","fainting","stroke","seizure","suicidal","can't breathe",
      "severe bleeding","unconscious","blue lips","heart attack"
    ];

    function looksEmergency(text) {
      const t = text.toLowerCase();
      return emergencyKeywords.some(k => t.includes(k));
    }

    function offlineMedicalResponse(q) {
      const t = q.toLowerCase();

      if (looksEmergency(q)) {
        return "This may be an emergency. Call 911 now (or your local emergency number). If an AED is available, use it. If the person is unresponsive and not breathing normally, start CPR and follow the CPR section below.";
      }

      if (t.includes("lupus")) {
        return "For lupus, prevention usually means pacing your energy, protecting sleep, tracking triggers (stress, sun exposure, infections), and staying consistent with clinician guidance. Tell me your goal: fatigue, pain, flares, hydration, or a simple daily routine?";
      }

      if (t.includes("blood pressure") || t.includes("bp")) {
        return "Blood pressure tracking tip: measure at the same time daily, sit quietly for 5 minutes, feet flat, arm supported at heart level. If readings are very high with symptoms (chest pain, severe headache, vision changes), seek urgent care.";
      }

      if (t.includes("steps") || t.includes("exercise")) {
        return "A safe approach: start low, go slow, and increase in small weekly steps. For lupus, gentle movement + rest breaks is often better than pushing hard. Want a 7-day gradual plan?";
      }

      if (t.includes("water") || t.includes("hydration")) {
        return "Hydration helps energy and overall health. A simple method: aim for steady intake across the day (not all at once). If you have kidney/heart restrictions, follow your clinician‚Äôs fluid guidance.";
      }

      return "I can help with education, checklists, and questions to ask your clinician. Tell me: what symptoms are you noticing, how long, and what makes it better or worse?";
    }

    $("btnSend").addEventListener("click", () => {
      const text = (chatInput.value || "").trim();
      if (!text) return;

      addMsg("You", text, "user");
      chatInput.value = "";

      const resp = offlineMedicalResponse(text);
      addMsg("Medical AI", resp, "ai");
    });

    chatInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") $("btnSend").click();
    });

    // Scroll buttons
    $("btnScrollChat").addEventListener("click", () => {
      $("chatSection").scrollIntoView({ behavior: "smooth", block: "start" });
      setTimeout(() => chatInput.focus(), 350);
    });

    $("btnScrollCPR").addEventListener("click", () => {
      $("cprSection").scrollIntoView({ behavior: "smooth", block: "start" });
    });

    // Footer year
    $("year").textContent = new Date().getFullYear();

    // Initial render + greeting
    renderToday();
    addMsg("Medical AI", "Hi ‚Äî I‚Äôm your prevention-first Medical AI (educational only). Ask me about lupus-friendly routines, BP tracking, symptoms to watch, or what to ask your doctor.", "ai");

    // ===========================
    // CPR Voice Reader (Text-to-Speech)
    // ===========================
    (() => {
      const speakBtn = $("cprSpeakBtn");
      const pauseBtn = $("cprPauseBtn");
      const resumeBtn = $("cprResumeBtn");
      const stopBtn = $("cprStopBtn");

      const rateEl = $("cprRate");
      const rateLabel = $("cprRateLabel");
      const statusEl = $("cprVoiceStatus");

      const hasTTS = "speechSynthesis" in window && "SpeechSynthesisUtterance" in window;

      const setStatus = (msg) => { if (statusEl) statusEl.textContent = msg; };

      const setButtons = ({ speaking=false, paused=false } = {}) => {
        speakBtn.disabled = !hasTTS || speaking;
        pauseBtn.disabled = !hasTTS || !speaking || paused;
        resumeBtn.disabled = !hasTTS || !speaking || !paused;
        stopBtn.disabled = !hasTTS || (!speaking && !paused);
      };

      const buildCPRScript = () => {
        const title = document.querySelector(".cpr-card h2")?.textContent?.trim() || "CPR Instructions";
        const items = [...document.querySelectorAll(".cpr-steps li")].map(li =>
          li.textContent.replace(/\s+/g, " ").trim()
        );
        const note = document.querySelector(".cpr-note")?.textContent?.replace(/\s+/g, " ").trim() || "";

        return [
          `${title}.`,
          "If you believe someone is not breathing normally, call 9 1 1.",
          ...items.map((t, i) => `Step ${i + 1}. ${t}.`),
          note ? `Note: ${note}.` : "",
          "End of CPR instructions."
        ].filter(Boolean).join(" ");
      };

      let utter = null;

      const stopSpeaking = () => {
        if (!hasTTS) return;
        window.speechSynthesis.cancel();
        utter = null;
        setButtons({ speaking:false, paused:false });
        setStatus("Stopped.");
      };

      const speak = () => {
        if (!hasTTS) {
          setStatus("Voice reading not supported in this browser. Try Chrome or Edge.");
          return;
        }
        window.speechSynthesis.cancel();

        const text = buildCPRScript();
        utter = new SpeechSynthesisUtterance(text);

        const rate = parseFloat(rateEl?.value || "1");
        utter.rate = Number.isFinite(rate) ? rate : 1;

        utter.onstart = () => {
          setButtons({ speaking:true, paused:false });
          setStatus("Reading CPR instructions‚Ä¶");
        };

        utter.onend = () => {
          setButtons({ speaking:false, paused:false });
          setStatus("Finished reading.");
        };

        utter.onerror = () => {
          setButtons({ speaking:false, paused:false });
          setStatus("Voice error. Try again or switch browsers.");
        };

        window.speechSynthesis.speak(utter);
      };

      const pause = () => {
        if (!hasTTS) return;
        if (window.speechSynthesis.speaking && !window.speechSynthesis.paused) {
          window.speechSynthesis.pause();
          setButtons({ speaking:true, paused:true });
          setStatus("Paused.");
        }
      };

      const resume = () => {
        if (!hasTTS) return;
        if (window.speechSynthesis.paused) {
          window.speechSynthesis.resume();
          setButtons({ speaking:true, paused:false });
          setStatus("Resumed.");
        }
      };

      speakBtn.addEventListener("click", speak);
      pauseBtn.addEventListener("click", pause);
      resumeBtn.addEventListener("click", resume);
      stopBtn.addEventListener("click", stopSpeaking);

      rateEl?.addEventListener("input", () => {
        const v = parseFloat(rateEl.value || "1");
        if (rateLabel) rateLabel.textContent = `${v.toFixed(2)}x`;
        // Restart so new speed applies immediately
        if (hasTTS && window.speechSynthesis.speaking) speak();
      });

      window.addEventListener("beforeunload", stopSpeaking);
      document.addEventListener("visibilitychange", () => { if (document.hidden) stopSpeaking(); });

      if (!hasTTS) setStatus("Voice reading not supported in this browser. Try Chrome or Edge.");
      setButtons({ speaking:false, paused:false });
    })();
  </script>
</body>
</html>
