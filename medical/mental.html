<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Medical AI Assistant | Health Hack</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Medical AI assistant for educational purposes. Prevention plans, blood pressure, steps, prescriptions, appointments, and emergency-only CPR guidance." />

  <style>
    :root{
      --bg:#060a14;
      --card:#0b1430;
      --card2:#070d1b;
      --border:rgba(140,160,220,.15);
      --text:#e9ecf1;
      --muted:#9aa4c7;
      --accent:#4da3ff;
      --danger:#ff6b6b;
      --ok:#43d19e;
      --warn:#ffcc66;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .container{max-width:1100px;margin:auto;padding:24px}
    h1,h2,h3{margin:0 0 10px}
    p{color:var(--muted); margin:0 0 14px}
    .grid{display:grid;gap:20px;grid-template-columns:1fr}
    @media(min-width:900px){.grid{grid-template-columns:1.2fr .8fr}}

    .card{
      background:linear-gradient(180deg,var(--card),var(--card2));
      border:1px solid var(--border);
      border-radius:18px;
      padding:20px;
    }

    /* ================= AI QUICK NAV (TOP RIGHT) ================= */
    .ai-nav{
      position:fixed;
      top:14px;
      right:16px;
      display:flex;
      gap:10px;
      z-index:9999;
    }
    .ai-btn{
      padding:10px 16px;
      border-radius:999px;
      font-size:14px;
      font-weight:800;
      text-decoration:none;
      color:#fff;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(10,18,45,.55);
      backdrop-filter: blur(10px);
      box-shadow:0 10px 28px rgba(0,0,0,.45);
      transition:transform .15s ease, box-shadow .15s ease, filter .15s ease;
      white-space:nowrap;
    }
    .ai-btn:hover{
      transform:translateY(-2px);
      box-shadow:0 14px 36px rgba(0,0,0,.55);
      filter:brightness(1.05);
    }
    .ai-btn:active{transform:translateY(0)}
    .ai-btn.medical{background:linear-gradient(135deg,#ff5f6d,#ffc371)}
    .ai-btn.nutrition{background:linear-gradient(135deg,#56ab2f,#a8e063)}
    .ai-btn.psych{background:linear-gradient(135deg,#6a11cb,#2575fc)}

    @media(max-width:640px){
      .ai-nav{
        top:auto;
        bottom:14px;
        right:50%;
        transform:translateX(50%);
        flex-wrap:wrap;
        justify-content:center;
      }
    }

    .top-row{
      display:flex; gap:12px; flex-wrap:wrap;
      align-items:center; justify-content:space-between;
      margin: 14px 0 18px;
    }
    .pill{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .badge{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
      background:rgba(77,163,255,.08);
    }
    .disclaimer{
      border-left:4px solid var(--danger);
      padding:14px 16px;
      background:rgba(255,107,107,.08);
      border-radius:14px;
      margin-bottom:16px;
      font-size:14px;
    }

    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    select,input,button,textarea{
      background:#0b1430;
      color:#fff;
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px 14px;
      font-size:15px;
      outline:none;
    }
    textarea{width:100%; min-height:86px; resize:vertical; line-height:1.4}
    button{
      cursor:pointer;
      background:linear-gradient(180deg,#4da3ff,#357edd);
      border:none;
      font-weight:800;
    }
    button.secondary{
      background:#0b1430;
      border:1px solid var(--border);
      font-weight:800;
    }

    .chat-box{display:flex;flex-direction:column;height:440px}
    .messages{flex:1;overflow-y:auto;padding-right:6px}
    .msg{margin-bottom:14px;line-height:1.45;white-space:pre-wrap}
    .user{color:#fff}
    .ai{color:#b7d6ff}
    .system{color:var(--muted); font-size:13px}
    .input-row{display:flex;gap:10px;margin-top:12px}
    .input-row input{flex:1}

    .stat{
      display:flex; justify-content:space-between;
      margin-bottom:12px; font-size:15px;
    }
    .small{font-size:13px;color:var(--muted)}
    .hr{border-top:1px solid var(--border); margin:18px 0}

    .tipcard{
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px;
      background:rgba(255,255,255,.03);
      margin-top:10px;
    }
    .tipcard h3{font-size:16px;margin-bottom:6px}
    .tips{margin:0; padding-left:18px; color:var(--muted)}
    .tips li{ margin:6px 0; }

    .flag{
      display:inline-flex; align-items:center; gap:8px;
      font-size:12px; padding:6px 10px; border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,204,102,.08);
      color:var(--warn);
    }

    .mini-btn{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:#fff;
      font-size:12px;
      text-decoration:none;
      cursor:pointer;
      margin-left:8px;
    }
    .mini-btn:hover{ filter:brightness(1.08); }
  </style>
</head>

<body>

  <!-- ================= AI QUICK NAV (TOP RIGHT) ================= -->
  <div class="ai-nav">
    <a href="/medical/medical.html" class="ai-btn medical">Medical AI</a>
    <a href="/meal/meal.html" class="ai-btn nutrition">Nutritionist AI</a>
    <a href="/psych/psychologist.html" class="ai-btn psych">Psychologist AI</a>
  </div>

  <div class="container">
    <h1>ðŸ©º Medical AI Assistant</h1>
    <p>Prevention-focused medical info + tracking â€” <strong>not a doctor</strong>.</p>

    <div class="top-row">
      <div class="pill">
        <span class="badge">Local-first â€¢ No Firebase</span>
        <span class="badge">Prevention Game Plans</span>
        <span class="badge">RX + Appointment reminders</span>
        <span class="badge">Emergency-only CPR</span>
      </div>

      <div class="row">
        <label class="small" for="conditionSelect">Condition Mode</label>
        <select id="conditionSelect" onchange="setConditionMode(this.value)">
          <option value="general">General</option>
          <option value="lupus">Lupus (SLE)</option>
          <option value="ckd3">Kidney Disease (CKD Stage 3)</option>
          <option value="htn">High Blood Pressure (Hypertension)</option>
          <option value="diabetes">Diabetes (General)</option>
          <option value="stress">Anxiety / Stress</option>
        </select>
      </div>
    </div>

    <div class="disclaimer">
      <strong>Important Disclaimer:</strong><br>
      This Medical AI is <strong>not a licensed medical professional</strong>. It does not diagnose or treat.
      Info is for <strong>education & prevention</strong>. For emergencies call <strong>911</strong>.
    </div>

    <div class="grid">

      <!-- ================= LEFT: CHAT ================= -->
      <div class="card">
        <h2>Medical AI Chat</h2>
        <p class="small">Ask a question. Iâ€™ll keep it educational, prevention-focused, and safety-first.</p>

        <div class="chat-box">
          <div class="messages" id="messages"></div>

          <div class="input-row">
            <input id="userInput" placeholder="Ask a medical questionâ€¦" />
            <button onclick="sendMessage()">Ask</button>
          </div>

          <div class="row" style="margin-top:10px; justify-content:space-between;">
            <button class="secondary" onclick="clearChat()">Clear Chat</button>
            <span id="modeFlag" class="flag" title="Current AI scope">Mode: General</span>
          </div>
        </div>
      </div>

      <!-- ================= RIGHT: TRACKING + PLANS ================= -->
      <div class="card">
        <h2>Health Metrics</h2>

        <h3>Blood Pressure</h3>
        <div class="stat">
          <span>Last Reading</span>
          <span id="bpDisplay">Not recorded</span>
        </div>
        <div class="input-row">
          <input id="systolic" inputmode="numeric" placeholder="Systolic (e.g. 120)" />
          <input id="diastolic" inputmode="numeric" placeholder="Diastolic (e.g. 80)" />
          <button class="secondary" onclick="saveBP()">Save</button>
        </div>

        <div class="hr"></div>

        <h3>Steps</h3>
        <div class="stat">
          <span>Todayâ€™s Steps</span>
          <span id="stepsDisplay">0</span>
        </div>
        <div class="input-row">
          <input id="stepsInput" inputmode="numeric" placeholder="Enter steps" />
          <button class="secondary" onclick="saveSteps()">Save</button>
        </div>
        <p class="small">* Auto-tracking can be added later for mobile builds.</p>

        <div class="hr"></div>

        <h2>Condition Tips</h2>
        <p class="small">Updates when you change Condition Mode.</p>
        <div class="tipcard">
          <h3 id="tipsTitle">General Guidance</h3>
          <ul class="tips" id="tipsList"></ul>
          <p class="small" id="tipsNote" style="margin-top:10px;"></p>
        </div>

        <div class="hr"></div>

        <h2>Prevention Game Plan</h2>
        <p class="small">Pick a goal. Larry generates small missions you can actually do.</p>

        <div class="input-row">
          <select id="goalSelect">
            <option value="general">General Healthy Living</option>
            <option value="bp">Lower Blood Pressure</option>
            <option value="steps">Walk More</option>
            <option value="sleep">Better Sleep</option>
            <option value="hydration">Hydration</option>
            <option value="stress">Stress / Anxiety</option>
            <option value="ckd">Kidney-Friendly Habits</option>
            <option value="lupus">Lupus-Friendly Habits</option>
          </select>
          <button class="secondary" onclick="generatePlan()">Generate Plan</button>
        </div>

        <div class="tipcard">
          <h3 id="planTitle">Todayâ€™s Missions</h3>
          <ul class="tips" id="planList"></ul>
          <p class="small" id="planNote" style="margin-top:10px;"></p>
        </div>

        <div class="hr"></div>

        <h2>Prescriptions & Due Dates</h2>
        <p class="small">Track meds + refills locally. Not medical advice.</p>

        <div class="input-row">
          <input id="rxName" placeholder="Medication name (e.g., Lisinopril)" />
          <input id="rxDose" placeholder="Dose (e.g., 10mg)" />
        </div>
        <div class="input-row">
          <input id="rxTime" placeholder="Take time (e.g., 8:00 AM)" />
          <input id="rxRefillDate" type="date" />
          <button class="secondary" onclick="addRx()">Add</button>
        </div>

        <div class="tipcard">
          <h3>My Prescriptions</h3>
          <ul class="tips" id="rxList"></ul>
          <p class="small">* For dosing/changes, follow your clinicianâ€™s plan.</p>
        </div>

        <div class="hr"></div>

        <h2>Appointments & Reminders</h2>
        <p class="small">Save doctor appointments locally.</p>

        <div class="input-row">
          <input id="apptTitle" placeholder="Appointment (e.g., Nephrology follow-up)" />
          <input id="apptDate" type="date" />
        </div>
        <div class="input-row">
          <input id="apptTime" placeholder="Time (e.g., 2:30 PM)" />
          <button class="secondary" onclick="addAppt()">Add</button>
        </div>

        <div class="tipcard">
          <h3>My Appointments</h3>
          <ul class="tips" id="apptList"></ul>
        </div>

        <div class="hr"></div>

        <h2>Emergency Skills</h2>
        <p class="small">CPR steps are shown only when you ask or during emergencies.</p>
        <button class="secondary" onclick="showCPR()">Teach CPR (Emergency Only)</button>

      </div>
    </div>
  </div>

<script>
/* ================= STORAGE KEYS ================= */
const bpKey = "health.bp.v1";
const stepsKey = "health.steps.v1";
const conditionKey = "health.conditionMode.v1";
const chatKey = "health.medicalChat.v1";
const planKey = "health.gameplan.v1";
const rxKey = "health.rx.v1";
const apptKey = "health.appt.v1";

/* ================= CONDITION PLAYBOOK ================= */
const CONDITIONS = {
  general: {
    label: "General",
    tipsTitle: "General Guidance",
    tips: [
      "If symptoms are severe, sudden, or worsening fast, seek urgent care.",
      "Track basics daily: sleep, hydration, stress, steps, and blood pressure.",
      "For new meds/supplements, check interactions with a pharmacist or clinician.",
      "Bring a symptom timeline to appointments (when it started, triggers, what helps)."
    ],
    note: "Educational only. For diagnosis/treatment, consult a licensed clinician."
  },
  lupus: {
    label: "Lupus (SLE)",
    tipsTitle: "Lupus (SLE) â€” Daily Focus",
    tips: [
      "Pace activity: plan rest breaks to help prevent flares.",
      "Sun protection matters: SPF + protective clothing; UV can trigger symptoms.",
      "Track flare signals: fatigue, joint pain, rash, fever, swelling, mouth sores.",
      "Medication adherence matters. Donâ€™t stop meds abruptly without clinician guidance."
    ],
    note: "If chest pain, shortness of breath, confusion, or sudden swelling â†’ urgent care."
  },
  ckd3: {
    label: "CKD Stage 3",
    tipsTitle: "CKD Stage 3 â€” Daily Focus",
    tips: [
      "Blood pressure control is keyâ€”log BP consistently.",
      "Hydration guidance is personalâ€”follow your care plan.",
      "Be cautious with NSAIDs unless your clinician says itâ€™s ok.",
      "Watch sodium and ultra-processed foods; ask about protein targets."
    ],
    note: "CKD advice must be individualized. Ask about potassium/phosphorus & medication safety."
  },
  htn: {
    label: "Hypertension",
    tipsTitle: "Hypertension â€” Daily Focus",
    tips: [
      "Measure BP correctly: seated, relaxed, arm supported, same time daily.",
      "Lower sodium; movement and sleep quality can improve BP.",
      "Know red flags: very high BP + chest pain, weakness, vision changes â†’ urgent care."
    ],
    note: "Donâ€™t self-adjust prescriptions. Follow your clinician plan."
  },
  diabetes: {
    label: "Diabetes (General)",
    tipsTitle: "Diabetes â€” Daily Focus",
    tips: [
      "Meals: fiber + protein + healthy fats help reduce spikes.",
      "Track patterns: meals, activity, sleep, stress.",
      "Know low sugar signs (shaking, sweating, confusion) and follow your care plan."
    ],
    note: "For dosing/insulin questions, follow your clinicianâ€™s plan."
  },
  stress: {
    label: "Anxiety / Stress",
    tipsTitle: "Anxiety / Stress â€” Daily Focus",
    tips: [
      "Quick reset: inhale 4, exhale 6 for 2â€“5 minutes.",
      "Reduce stimulants if anxiety is high.",
      "Move daily. Track triggers and sleep patterns.",
      "If you feel unsafe, seek immediate help (US: 988)."
    ],
    note: "This isnâ€™t therapy. If severe/persistent, consider professional support."
  }
};

/* ================= EMERGENCY DETECTION ================= */
const emergencyKeywords = [
  "chest pain","shortness of breath","stroke","seizure","fainting",
  "severe headache","vision loss","can't breathe","cannot breathe",
  "suicidal","kill myself","face drooping","one sided weakness","confusion","unresponsive",
  "not breathing","no pulse","cpr","cardiac arrest"
];

let currentMode = "general";

/* ================= INIT ================= */
(function init(){
  // load BP
  const bp = safeParse(localStorage.getItem(bpKey));
  if(bp && bp.sys && bp.dia) document.getElementById("bpDisplay").textContent = `${bp.sys}/${bp.dia} mmHg`;

  // load steps
  const steps = localStorage.getItem(stepsKey);
  if(steps) document.getElementById("stepsDisplay").textContent = steps;

  // load mode
  const savedMode = localStorage.getItem(conditionKey);
  if(savedMode && CONDITIONS[savedMode]) currentMode = savedMode;
  document.getElementById("conditionSelect").value = currentMode;
  applyModeUI();

  // load chat
  const savedChat = safeParse(localStorage.getItem(chatKey)) || [];
  if(savedChat.length){
    savedChat.forEach(m => m.role === "user" ? addUser(m.text, false) : addAI(m.text, false, m.kind));
    scrollChat();
  } else {
    addAI(`Hi. Iâ€™m your Medical AI assistant. I focus on prevention and safety-first education. Current mode: ${CONDITIONS[currentMode].label}.`, true, "system");
  }

  // load extras
  renderRx();
  renderAppts();
  loadPlan();
})();

/* ================= HELPERS ================= */
function safeParse(s){ try { return JSON.parse(s); } catch { return null; } }

function persistChat(role, text, kind="normal"){
  const arr = safeParse(localStorage.getItem(chatKey)) || [];
  arr.push({ role, text, kind, t: Date.now(), mode: currentMode });
  localStorage.setItem(chatKey, JSON.stringify(arr.slice(-200)));
}
function scrollChat(){
  const box = document.getElementById("messages");
  box.scrollTop = box.scrollHeight;
}
function addUser(text, persist=true){
  const div = document.createElement("div");
  div.className="msg user";
  div.textContent="You: " + text;
  document.getElementById("messages").appendChild(div);
  if(persist) persistChat("user", text);
  scrollChat();
}
function addAI(text, persist=true, kind="normal"){
  const div = document.createElement("div");
  div.className = "msg " + (kind === "system" ? "system" : "ai");
  div.textContent = (kind === "system" ? "Note: " : "Medical AI: ") + text;
  document.getElementById("messages").appendChild(div);
  if(persist) persistChat("ai", text, kind);
  scrollChat();
}

function renderList(ulId, items){
  const ul = document.getElementById(ulId);
  ul.innerHTML = "";
  (items || []).forEach(t => {
    const li = document.createElement("li");
    li.textContent = t;
    ul.appendChild(li);
  });
}

/* ================= MODE ================= */
function setConditionMode(mode){
  if(!CONDITIONS[mode]) mode = "general";
  currentMode = mode;
  localStorage.setItem(conditionKey, currentMode);
  applyModeUI();
  addAI(`Condition Mode set to: ${CONDITIONS[currentMode].label}.`, true, "system");
}
function applyModeUI(){
  const info = CONDITIONS[currentMode] || CONDITIONS.general;
  document.getElementById("modeFlag").textContent = `Mode: ${info.label}`;
  document.getElementById("tipsTitle").textContent = info.tipsTitle;
  renderList("tipsList", info.tips);
  document.getElementById("tipsNote").textContent = info.note;
}

/* ================= GAME PLAN ================= */
function loadPlan(){
  const saved = safeParse(localStorage.getItem(planKey));
  if(saved && saved.items){
    document.getElementById("planTitle").textContent = saved.title || "Todayâ€™s Missions";
    renderList("planList", saved.items);
    document.getElementById("planNote").textContent = saved.note || "";
  } else {
    generatePlan();
  }
}

function generatePlan(){
  const goal = document.getElementById("goalSelect").value;

  const plans = {
    general:{ title:"Todayâ€™s Missions (General)", items:[
      "Drink water with every meal (3x).",
      "Walk 10 minutes (or 1,000â€“2,000 steps).",
      "Add 1 fruit or veggie serving.",
      "Do 5 minutes of light stretching.",
      "Write one symptom/energy note today."
    ], note:"Small wins stack. Consistency beats intensity."},

    bp:{ title:"Todayâ€™s Missions (Blood Pressure)", items:[
      "Measure BP once today (seated, calm). Log it.",
      "Swap one salty item for a lower-sodium option.",
      "Take a 10â€“20 minute walk.",
      "Do 2 minutes of slow breathing (inhale 4, exhale 6).",
      "Plan tomorrowâ€™s breakfast (avoid ultra-processed)."
    ], note:"If you feel unwell with very high BP, treat it as urgent."},

    steps:{ title:"Todayâ€™s Missions (Steps)", items:[
      "Take a 5â€“10 minute walk after a meal.",
      "Stand up and move for 2 minutes every hour.",
      "Add 500 steps to your baseline.",
      "Stretch calves/hips for 3 minutes.",
      "Log your steps at day end."
    ], note:"Start small; add 250â€“500 steps per day each week."},

    sleep:{ title:"Todayâ€™s Missions (Sleep)", items:[
      "Set a consistent bedtime window (Â±30 min).",
      "No caffeine 8 hours before bed.",
      "Dim screens 45 minutes before sleep.",
      "Write a 3-line brain-dump before bed.",
      "Bedroom cool + dark check."
    ], note:"Sleep helps BP, glucose, stress, and recovery."},

    hydration:{ title:"Todayâ€™s Missions (Hydration)", items:[
      "Start day with 8â€“12 oz water.",
      "Drink 8 oz with each meal.",
      "Carry water during any outing.",
      "Log total ounces in Water tab.",
      "Swap one sugary drink for water."
    ], note:"If CKD/heart failure, fluid limits can be individualizedâ€”follow your plan."},

    stress:{ title:"Todayâ€™s Missions (Stress/Anxiety)", items:[
      "2 minutes breathing: inhale 4, exhale 6.",
      "10-minute walk (even indoors).",
      "Do one small task to reduce chaos.",
      "Write one worry â†’ one next step.",
      "Limit doom-scrolling to a set time."
    ], note:"If you feel unsafe or at risk of self-harm, seek immediate help (US: 988)."},

    ckd:{ title:"Todayâ€™s Missions (Kidney-Friendly)", items:[
      "Log BP once today (trend tracking).",
      "Choose one lower-sodium meal/snack.",
      "Avoid NSAIDs unless clinician approved.",
      "Walk 10 minutes (as tolerated).",
      "Write 1 question for your clinician (labs/meds/diet)."
    ], note:"Use as coaching, not a prescription. CKD plans are personal."},

    lupus:{ title:"Todayâ€™s Missions (Lupus-Friendly)", items:[
      "Sun protection check (SPF/clothing).",
      "Pace activity: schedule 1 rest break.",
      "Track flare signs (fatigue/joints/rash).",
      "Gentle movement (stretch or short walk).",
      "Plan one calming activity today."
    ], note:"Chest pain, SOB, confusion, sudden swelling â†’ urgent care."}
  };

  const plan = plans[goal] || plans.general;
  document.getElementById("planTitle").textContent = plan.title;
  renderList("planList", plan.items);
  document.getElementById("planNote").textContent = plan.note;
  localStorage.setItem(planKey, JSON.stringify(plan));
}

/* ================= RX TRACKING ================= */
function addRx(){
  const name = document.getElementById("rxName").value.trim();
  const dose = document.getElementById("rxDose").value.trim();
  const time = document.getElementById("rxTime").value.trim();
  const refillDate = document.getElementById("rxRefillDate").value;

  if(!name) return alert("Add a medication name.");

  const arr = safeParse(localStorage.getItem(rxKey)) || [];
  arr.push({ id: (crypto.randomUUID ? crypto.randomUUID() : String(Date.now())), name, dose, time, refillDate, created: Date.now() });
  localStorage.setItem(rxKey, JSON.stringify(arr));

  document.getElementById("rxName").value="";
  document.getElementById("rxDose").value="";
  document.getElementById("rxTime").value="";
  document.getElementById("rxRefillDate").value="";

  renderRx();
  addAI("Prescription saved locally on this device. (Not medical advice.)", true, "system");
}

function deleteRx(id){
  const arr = safeParse(localStorage.getItem(rxKey)) || [];
  localStorage.setItem(rxKey, JSON.stringify(arr.filter(x => x.id !== id)));
  renderRx();
}

function renderRx(){
  const ul = document.getElementById("rxList");
  const arr = safeParse(localStorage.getItem(rxKey)) || [];
  ul.innerHTML = "";
  if(!arr.length){
    const li = document.createElement("li");
    li.textContent = "No prescriptions saved yet.";
    ul.appendChild(li);
    return;
  }
  arr.forEach(rx => {
    const li = document.createElement("li");
    const refillTxt = rx.refillDate ? ` â€¢ Refill: ${rx.refillDate}` : "";
    const timeTxt = rx.time ? ` â€¢ Take: ${rx.time}` : "";
    li.textContent = `${rx.name}${rx.dose ? " ("+rx.dose+")" : ""}${timeTxt}${refillTxt}`;
    const del = document.createElement("button");
    del.className = "mini-btn";
    del.textContent = "Remove";
    del.onclick = () => deleteRx(rx.id);
    li.appendChild(del);
    ul.appendChild(li);
  });
}

/* ================= APPOINTMENTS ================= */
function addAppt(){
  const title = document.getElementById("apptTitle").value.trim();
  const date = document.getElementById("apptDate").value;
  const time = document.getElementById("apptTime").value.trim();

  if(!title || !date) return alert("Add appointment title + date.");

  const arr = safeParse(localStorage.getItem(apptKey)) || [];
  arr.push({ id: (crypto.randomUUID ? crypto.randomUUID() : String(Date.now())), title, date, time, created: Date.now() });
  localStorage.setItem(apptKey, JSON.stringify(arr));

  document.getElementById("apptTitle").value="";
  document.getElementById("apptDate").value="";
  document.getElementById("apptTime").value="";

  renderAppts();
  addAI("Appointment saved locally on this device.", true, "system");
}

function deleteAppt(id){
  const arr = safeParse(localStorage.getItem(apptKey)) || [];
  localStorage.setItem(apptKey, JSON.stringify(arr.filter(x => x.id !== id)));
  renderAppts();
}

function renderAppts(){
  const ul = document.getElementById("apptList");
  const arr = safeParse(localStorage.getItem(apptKey)) || [];
  ul.innerHTML = "";
  if(!arr.length){
    const li = document.createElement("li");
    li.textContent = "No appointments saved yet.";
    ul.appendChild(li);
    return;
  }
  arr
    .slice()
    .sort((a,b) => (a.date > b.date ? 1 : -1))
    .forEach(ap => {
      const li = document.createElement("li");
      li.textContent = `${ap.title} â€¢ ${ap.date}${ap.time ? " â€¢ " + ap.time : ""}`;
      const del = document.createElement("button");
      del.className = "mini-btn";
      del.textContent = "Remove";
      del.onclick = () => deleteAppt(ap.id);
      li.appendChild(del);
      ul.appendChild(li);
    });
}

/* ================= CPR (EMERGENCY ONLY) ================= */
function showCPR(){
  addAI(
`CPR (Emergency Only) â€” quick guide:
1) Check responsiveness. Shout for help.
2) Call 911 (or local emergency). If possible, send someone to get an AED.
3) If not breathing normally: start chest compressions.
4) Hands center of chest. Push hard & fast (about 100â€“120/min), allow full recoil.
5) If trained, do 30 compressions + 2 breaths. If not trained, hands-only CPR is OK.
6) Use AED ASAP and follow prompts.
Stop only when help takes over or the person wakes/breathes normally.`,
  true,
  "system"
  );
}

/* ================= CHAT ================= */
function clearChat(){
  if(!confirm("Clear the chat history on this device?")) return;
  localStorage.removeItem(chatKey);
  document.getElementById("messages").innerHTML = "";
  addAI("Chat cleared. Prevention-first and safety-first, always.", true, "system");
}

function sendMessage(){
  const inputEl = document.getElementById("userInput");
  const input = inputEl.value.trim();
  if(!input) return;

  addUser(input);
  inputEl.value = "";

  const lc = input.toLowerCase();

  // Emergency detection: show CPR only if it's truly relevant
  if(emergencyKeywords.some(k => lc.includes(k))){
    addAI("âš ï¸ This may be an emergency. Call 911 now. If someone is not breathing or has no pulse, I can show CPR steps.", true, "system");
    if(lc.includes("not breathing") || lc.includes("no pulse") || lc.includes("cpr") || lc.includes("cardiac arrest")){
      showCPR();
    }
    return;
  }

  addAI(buildResponse(input, CONDITIONS[currentMode] || CONDITIONS.general));
}

function buildResponse(question, mode){
  return [
    "I can share general medical education and prevention ideas, not a diagnosis.",
    "",
    `Current mode: ${mode.label}.`,
    "",
    "To help you best, tell me:",
    "â€¢ Age range",
    "â€¢ Main symptoms or goal (prevention counts)",
    "â€¢ How long itâ€™s been going on",
    "â€¢ Any meds/supplements",
    "â€¢ What makes it better/worse",
    "",
    "If you want, say: â€œMake me a 7-day game plan for ___â€ and Iâ€™ll build it."
  ].join("\n");
}

/* ================= METRICS ================= */
function saveBP(){
  const sys = document.getElementById("systolic").value.trim();
  const dia = document.getElementById("diastolic").value.trim();
  if(!sys || !dia) return alert("Enter both systolic and diastolic values.");
  localStorage.setItem(bpKey, JSON.stringify({sys, dia, date: Date.now()}));
  document.getElementById("bpDisplay").textContent = `${sys}/${dia} mmHg`;
  document.getElementById("systolic").value = "";
  document.getElementById("diastolic").value = "";
  addAI("Saved your blood pressure reading locally on this device.", true, "system");
}
function saveSteps(){
  const steps = document.getElementById("stepsInput").value.trim();
  if(!steps) return;
  localStorage.setItem(stepsKey, steps);
  document.getElementById("stepsDisplay").textContent = steps;
  document.getElementById("stepsInput").value = "";
  addAI("Saved todayâ€™s steps locally on this device.", true, "system");
}

/* ================= ENTER TO SEND ================= */
document.addEventListener("keydown", (e) => {
  if(e.key === "Enter" && document.activeElement && document.activeElement.id === "userInput"){
    e.preventDefault();
    sendMessage();
  }
});
</script>

</body>
</html>
